<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web AR Try-On</title>
<style>
:root{--bg:#0b0f19;--panel:#0f1424;--text:#e7ecf3;--muted:#98a2b3;--accent:#7c3aed}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0b0f19;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;gap:12px;align-items:center;padding:10px 14px;background:#0e1426;border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-weight:700}.spacer{flex:1}
.seg{display:flex;gap:6px}
button, .seg button{border:1px solid rgba(255,255,255,.14);background:#111831;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.active, .seg button.active{background:var(--accent);border-color:transparent}
.thumbs{display:flex;gap:8px;margin-left:4px}
.thumb{width:64px;height:36px;object-fit:contain;background:#111831;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:2px;cursor:pointer;opacity:.85;transition:.15s}
.thumb:hover{opacity:1}
.thumb.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(124,58,237,.35) inset;opacity:1}
.currThumb{width:80px;height:44px;object-fit:contain;background:#111831;border-radius:8px;border:1px solid rgba(255,255,255,.12);padding:2px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#1f2937;color:#cbd5e1}
.badge.ok{background:#064e3b;color:#d1fae5}
main{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:12px}
.stage{display:grid;place-items:center;min-height:70vh;background:#0e1426;border-radius:12px}
.panel{background:#0e1426;border-radius:12px;padding:12px;display:grid;gap:12px;height:max-content}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.slider{display:grid;grid-template-columns:120px 1fr 64px;gap:8px;align-items:center}
.group{border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:#0f1424}
.group h4{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
img{max-width:100%;height:auto}
.hint{color:#94a3b8;font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">Web AR Try-On</div>

  <!-- æ—§çš„æ–‡æœ¬æŒ‰é’®è¿˜ä¿ç•™ï¼ˆå¯é€‰ï¼‰ï¼Œä¹Ÿå¯åªç”¨ç¼©ç•¥å›¾ -->
  <div class="seg">
    <button id="btnFrameA" class="active">Frame A</button>
    <button id="btnFrameB">Frame B</button>
    <button id="btnFrameC">Frame C</button>
  </div>

  <!-- å¯ç‚¹å‡»ç¼©ç•¥å›¾æ¡ -->
  <div class="thumbs" id="thumbBar">
    <img src="Frame_A.png" id="thumbA" class="thumb active" data-fid="A" alt="Frame A">
    <img src="Frame_B.png" id="thumbB" class="thumb" data-fid="B" alt="Frame B">
    <img src="Frame_C.png" id="thumbC" class="thumb" data-fid="C" alt="Frame C">
  </div>

  <div class="seg">
    <button id="srcServer" class="active">Server (MJPEG)</button>
  </div>

  <div class="spacer"></div>

  <!-- å½“å‰ Frame ç¼©ç•¥å›¾ -->
  <img id="currThumb" class="currThumb" src="Frame_A.png" alt="Current frame">

  <span id="frameBadge" class="badge">Frame: A</span>
  <span id="permBadge" class="badge">Ready</span>
  <span id="fpsBadge" class="badge">FPS: â€“</span>
  <span id="resBadge" class="badge">â€“ Ã— â€“</span>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="snap">ğŸ“¸ Snapshot</button>
</header>

<main>
  <div class="stage">
    <img id="mjpeg" alt="MJPEG stream"/>
  </div>

  <div class="panel">
    <div class="row">
      <label><input type="checkbox" id="autoHide"> Auto-hide temples</label>
      <label><input type="checkbox" id="occlusion"> Occlusion (arms behind face)</label>
    </div>
    <div class="row"><span class="badge">Pivot: Eye outer (263/33)</span></div>

    <div class="group">
      <h4>Global</h4>
      <div class="slider"><label>Scale</label> <input id="sScale"  type="range" min="0.6" max="1.8" step="0.01" value="1.0"><output id="oScale">1.00Ã—</output></div>
      <div class="slider"><label>Width</label> <input id="sScaleX" type="range" min="0.6" max="1.8" step="0.01" value="1.0"><output id="oScaleX">1.00Ã—</output></div>
      <div class="slider"><label>Height</label><input id="sScaleY" type="range" min="0.6" max="1.8" step="0.01" value="1.0"><output id="oScaleY">1.00Ã—</output></div>
      <div class="slider"><label>Shift (â†”)</label><input id="sShiftT" type="range" min="-0.5" max="0.5" step="0.005" value="0"><output id="oShiftT">0.000</output></div>
      <div class="slider"><label>Offset (â†•)</label><input id="sOffsetN" type="range" min="-0.5" max="0.5" step="0.005" value="0"><output id="oOffsetN">0.000</output></div>
      <div class="slider"><label>Temple rot</label><input id="sTempleRot" type="range" min="-20" max="20" step="0.5" value="5"><output id="oTempleRot">5.0Â°</output></div>
      <div class="row"><button id="btnReset">Reset</button><button id="btnExport">Export params</button></div>
      <div class="hint">Global ä½œç”¨äºå‰æ¡†ä¸ä¸¤ä¾§é•œè‡‚ï¼›ä¸‹é¢é•œè‡‚æ»‘æ†ä»…åšå¾®è°ƒã€‚</div>
    </div>

    <div class="group">
      <h4>Right temple overrideï¼ˆå±å¹•å³ â†’ åç«¯ Lï¼‰</h4>
      <div class="slider"><label>Right scale</label><input id="sTempleScaleL" type="range" min="0.5" max="1.8" step="0.01" value="1"><output id="oTempleScaleL">1.00Ã—</output></div>
      <div class="slider"><label>Right shift (â†”)</label><input id="sTempleShiftTL" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleShiftTL">0.000</output></div>
      <div class="slider"><label>Right offset (â†•)</label><input id="sTempleOffsetNL" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleOffsetNL">0.000</output></div>
      <div class="slider"><label>Right rot</label><input id="sTempleRotL" type="range" min="-25" max="25" step="0.5" value="5"><output id="oTempleRotL">5.0Â°</output></div>
    </div>

    <div class="group">
      <h4>Left temple overrideï¼ˆå±å¹•å·¦ â†’ åç«¯ Rï¼‰</h4>
      <div class="slider"><label>Left scale</label><input id="sTempleScaleR" type="range" min="0.5" max="1.8" step="0.01" value="1"><output id="oTempleScaleR">1.00Ã—</output></div>
      <div class="slider"><label>Left shift (â†”)</label><input id="sTempleShiftTR" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleShiftTR">0.000</output></div>
      <div class="slider"><label>Left offset (â†•)</label><input id="sTempleOffsetNR" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleOffsetNR">0.000</output></div>
      <div class="slider"><label>Left rot</label><input id="sTempleRotR" type="range" min="-25" max="25" step="0.5" value="-5"><output id="oTempleRotR">-5.0Â°</output></div>
    </div>
  </div>
</main>

<script>
(() => {
  const img = document.getElementById('mjpeg');

  // é¡¶éƒ¨æ§ä»¶
  const btnA = document.getElementById('btnFrameA');
  const btnB = document.getElementById('btnFrameB');
  const btnC = document.getElementById('btnFrameC');
  const frameBadge = document.getElementById('frameBadge');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const snapBtn  = document.getElementById('snap');
  const fpsBadge = document.getElementById('fpsBadge');
  const resBadge = document.getElementById('resBadge');
  const permBadge= document.getElementById('permBadge');
  const currThumb= document.getElementById('currThumb');
  const thumbBar = document.getElementById('thumbBar');

  // å¤é€‰æ¡†
  const autoHide  = document.getElementById('autoHide');
  const occlusion = document.getElementById('occlusion');

  // å…¨å±€æ»‘æ†
  const sScale = s('sScale'), sScaleX=s('sScaleX'), sScaleY=s('sScaleY'),
        sShiftT=s('sShiftT'), sOffsetN=s('sOffsetN'), sTempleRot=s('sTempleRot');

  // é•œè‡‚æ»‘æ†ï¼ˆå±å¹•å³â†’åç«¯Lï¼›å±å¹•å·¦â†’åç«¯Rï¼‰
  const sTempleScaleL=s('sTempleScaleL'), sTempleShiftTL=s('sTempleShiftTL'),
        sTempleOffsetNL=s('sTempleOffsetNL'), sTempleRotL=s('sTempleRotL');
  const sTempleScaleR=s('sTempleScaleR'), sTempleShiftTR=s('sTempleShiftTR'),
        sTempleOffsetNR=s('sTempleOffsetNR'), sTempleRotR=s('sTempleRotR');

  function s(id){ return document.getElementById(id); }
  function o(id){ return document.getElementById(id); }

  function setRunning(r){
    startBtn.disabled = r; stopBtn.disabled = !r; snapBtn.disabled = !r;
  }

  function api(p){ return p; }

  function highlight(fid){
    // æ–‡æœ¬æŒ‰é’®é«˜äº®
    [btnA,btnB,btnC].forEach(b=>b.classList.remove('active'));
    ({A:btnA,B:btnB,C:btnC}[fid]).classList.add('active');
    // ç¼©ç•¥å›¾é«˜äº®
    [...thumbBar.querySelectorAll('.thumb')].forEach(t=>t.classList.remove('active'));
    ({A:thumbA,B:thumbB,C:thumbC}[fid]).classList.add('active');
    // å½“å‰ç¼©ç•¥å›¾
    currThumb.src = `Frame_${fid}.png`;
    frameBadge.textContent = 'Frame: ' + fid;
  }

  function setFrame(fid, silent=false){
    highlight(fid);
    if (!silent) {
      fetch(api('/api/switch_frame'), {method:'POST', headers:{'Content-Type':'application/json'},
             body:JSON.stringify({id:fid})}).catch(()=>{});
    }
  }

  function readGlobal(){
    return {
      scale:+sScale.value, scaleX:+sScaleX.value, scaleY:+sScaleY.value,
      shiftT:+sShiftT.value, offsetN:+sOffsetN.value, templeRotDeg:+sTempleRot.value,
      occlusion: occlusion.checked, autoHideTemples: autoHide.checked,
      pivotMode: 'eye_outer'
    };
  }
  function readLeft(){
    return {
      templeScaleL:+sTempleScaleL.value,
      templeShiftTL:+sTempleShiftTL.value,
      templeOffsetNL:+sTempleOffsetNL.value,
      templeRotL:+sTempleRotL.value
    };
  }
  function readRight(){
    return {
      templeScaleR:+sTempleScaleR.value,
      templeShiftTR:+sTempleShiftTR.value,
      templeOffsetNR:+sTempleOffsetNR.value,
      templeRotR:+sTempleRotR.value
    };
  }
  function updateOutputs(){
    o('oScale').textContent   = (+sScale.value).toFixed(2)+'Ã—';
    o('oScaleX').textContent  = (+sScaleX.value).toFixed(2)+'Ã—';
    o('oScaleY').textContent  = (+sScaleY.value).toFixed(2)+'Ã—';
    o('oShiftT').textContent  = (+sShiftT.value).toFixed(3);
    o('oOffsetN').textContent = (+sOffsetN.value).toFixed(3);
    o('oTempleRot').textContent = (+sTempleRot.value).toFixed(1)+'Â°';

    o('oTempleScaleL').textContent = (+sTempleScaleL.value).toFixed(2)+'Ã—';
    o('oTempleShiftTL').textContent= (+sTempleShiftTL.value).toFixed(3);
    o('oTempleOffsetNL').textContent=(+sTempleOffsetNL.value).toFixed(3);
    o('oTempleRotL').textContent   = (+sTempleRotL.value).toFixed(1)+'Â°';

    o('oTempleScaleR').textContent = (+sTempleScaleR.value).toFixed(2)+'Ã—';
    o('oTempleShiftTR').textContent= (+sTempleShiftTR.value).toFixed(3);
    o('oTempleOffsetNR').textContent=(+sTempleOffsetNR.value).toFixed(3);
    o('oTempleRotR').textContent   = (+sTempleRotR.value).toFixed(1)+'Â°';
  }
  function postParams(extra){
    const body = Object.assign({}, readGlobal(), readLeft(), readRight(), extra||{});
    fetch(api('/api/params'), {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)}).catch(()=>{});
  }
  function pushAll(){ updateOutputs(); postParams(); }

  // äº‹ä»¶ç»‘å®š
  [autoHide, occlusion,
   sScale,sScaleX,sScaleY,sShiftT,sOffsetN,sTempleRot,
   sTempleScaleL,sTempleShiftTL,sTempleOffsetNL,sTempleRotL,
   sTempleScaleR,sTempleShiftTR,sTempleOffsetNR,sTempleRotR
  ].forEach(el => el.addEventListener('input', ()=>{ updateOutputs(); postParams(); }));

  // Reset & Export
  document.getElementById('btnReset').onclick = () => {
    sScale.value=1; sScaleX.value=1; sScaleY.value=1; sShiftT.value=0; sOffsetN.value=0; sTempleRot.value=5;
    sTempleScaleL.value=1; sTempleShiftTL.value=0; sTempleOffsetNL.value=0; sTempleRotL.value=5;
    sTempleScaleR.value=1; sTempleShiftTR.value=0; sTempleOffsetNR.value=0; sTempleRotR.value=-5;
    autoHide.checked=false; occlusion.checked=false;
    pushAll();
  };
  document.getElementById('btnExport').onclick = () => {
    const txt = JSON.stringify(Object.assign({}, readGlobal(), readLeft(), readRight()), null, 2);
    navigator.clipboard.writeText(txt); alert('å·²å¤åˆ¶å‚æ•°åˆ°å‰ªè´´æ¿');
  };

  // æ–‡æœ¬æŒ‰é’®åˆ‡æ¢
  btnA.onclick = ()=>setFrame('A');
  btnB.onclick = ()=>setFrame('B');
  btnC.onclick = ()=>setFrame('C');

  // ç¼©ç•¥å›¾ç‚¹å‡»åˆ‡æ¢
  thumbBar.addEventListener('click', (e)=>{
    const t = e.target.closest('.thumb'); if(!t) return;
    setFrame(t.dataset.fid);
  });

  // å¯åœä¸å¿«ç…§
  let raf=0, frames=0, last=performance.now();
  function loop(){
    frames++; const now=performance.now();
    if(now-last>500){ const fps=Math.round(frames*1000/(now-last)); fpsBadge.textContent=`FPS: ${fps}`; frames=0; last=now; }
    const w=img.naturalWidth|0, h=img.naturalHeight|0; if(w&&h) document.getElementById('resBadge').textContent=`${w} Ã— ${h}`;
    raf = requestAnimationFrame(loop);
  }
  document.getElementById('start').onclick = () => {
    setRunning(true);
    permBadge.textContent='Running'; permBadge.classList.add('ok');
    cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
    img.onerror = () => setTimeout(()=>{ img.src = '/stream.mjpg?ts='+Date.now(); }, 800);
    img.src = '/stream.mjpg?ts='+Date.now();
    pushAll();
  };
  document.getElementById('stop').onclick = () => {
    if(raf) cancelAnimationFrame(raf);
    img.removeAttribute('src');
    setRunning(false);
    permBadge.textContent='Stopped'; permBadge.classList.remove('ok');
  };
  document.getElementById('snap').onclick = () => {
    const a=document.createElement('a'); a.download=`snapshot_${Date.now()}.jpg`; a.href='/snapshot'; a.click();
  };

  // åˆå§‹åŒ–ï¼šä»¥æœåŠ¡ç«¯ state ä¸ºå‡†
  fetch('/api/params').then(r=>r.json()).then(st=>{
    const fid = (st && st.frameId) || 'A';
    highlight(fid);
  }).catch(()=>highlight('A'));
})();
</script>
</body>
</html>

