<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Web AR Try-On</title>
  <style>
    :root{--bg:#0b0f19;--panel:#121828;--text:#e7ecf3;--muted:#98a2b3;--accent:#4f46e5}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(100% 100% at 50% 0%,#0f172a 0%,#0b0f19 100%);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:12px;padding:10px 16px;background:rgba(18,24,40,.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    header .brand{font-weight:700} .spacer{flex:1}
    header button,header select{appearance:none;border:1px solid rgba(255,255,255,.12);background:#0f1424;color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    header button:hover{border-color:rgba(255,255,255,.22)} header button:disabled{opacity:.6;cursor:not-allowed}
    .seg{display:flex;border:1px solid rgba(255,255,255,.12);border-radius:10px;overflow:hidden}
    .seg button{border:0;background:#0f1424;color:var(--text);padding:8px 12px;font-weight:600;cursor:pointer}
    .seg button+button{border-left:1px solid rgba(255,255,255,.12)} .seg button.active{background:var(--accent);color:#fff}
    .stage{position:relative;display:grid;place-items:center;padding:12px;height:100%}
    .viewport{position:relative;width:min(100%,960px);aspect-ratio:16/9;background:#0a0f1f;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    video, img.stream {position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    canvas#overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .statusbar{position:absolute;inset:auto 12px 12px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:20px;background:rgba(255,255,255,.06);color:var(--muted);border:1px solid rgba(255,255,255,.1)}
    .badge.ok{color:#10b981;background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3)}
    .badge.err{color:#ef4444;background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.3)}
    .badge.warn{color:#f59e0b;background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.3)}
    .panel{width:min(100%,960px);margin:10px auto 0;background:rgba(18,24,40,.7);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;display:grid;gap:10px}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px} @media(max-width:920px){.grid{grid-template-columns:repeat(2,1fr)}}
    .ctrl{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:#0f1424}
    .ctrl label{display:flex;align-items:center;justify-content:space-between;font-weight:600}
    .ctrl output{color:#a8b3cf;font-variant-numeric:tabular-nums}
    .ctrl input[type=range]{width:100%;margin-top:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row .switch{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:#0f1424}
    .row .switch input{accent-color:var(--accent);transform:scale(1.1)}
    .row .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f1424;color:var(--text);font-weight:600;cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">Web AR Try-On</div>

    <!-- Frame åˆ‡æ¢ï¼ˆå ä½ï¼Œåç«¯æœªæ¥å¯æ¥ /api/frameï¼‰ -->
    <div class="seg" id="frameSwitcher" role="group" aria-label="Frame switcher">
      <button id="btnFrameA" class="active" type="button">Frame A</button>
      <button id="btnFrameB" type="button">Frame B</button>
      <button id="btnFrameC" type="button">Frame C</button>
    </div>

    <!-- NEW: æ¥æºåˆ‡æ¢ -->
    <div class="seg" id="sourceSwitcher" role="group" aria-label="Source switcher" style="margin-left:8px">
      <button id="srcWebcam" class="active" type="button">WebCam</button>
      <button id="srcServer" type="button">Server (MJPEG)</button>
    </div>

    <div class="spacer"></div>
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
    <button id="snap" disabled>ğŸ“¸ Snapshot</button>
    <div id="frameBadge" class="badge">Frame: A</div>
  </header>

  <main class="stage">
    <div class="viewport">
      <video id="cam" playsinline muted></video>
      <img id="mjpeg" class="stream" alt="" style="display:none">
      <canvas id="overlay"></canvas>
      <div class="statusbar">
        <div id="perm" class="badge">Ready</div>
        <div id="fps" class="badge">FPS: â€“</div>
        <div id="res" class="badge">â€“ Ã— â€“</div>
        <div id="env" class="badge warn" style="display:none"></div>
      </div>
    </div>

    <!-- æ‰‹åŠ¨å¾®è°ƒï¼ˆUI å ä½ï¼›æœªæ¥æŠŠå‚æ•° POST ç»™åç«¯ /api/params å³å¯ï¼‰ -->
    <section class="panel">
      <div class="row">
        <label class="switch"><input type="checkbox" id="autoFit" checked> <span>Auto-fit</span></label>
        <button class="btn" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnExport" type="button">Export params</button>
      </div>
      <div class="grid">
        <div class="ctrl"><label>Scale <output id="oScale">1.00Ã—</output></label><input id="sScale" type="range" min="0.60" max="2.00" step="0.01" value="1.00"></div>
        <div class="ctrl"><label>Width <output id="oScaleX">1.00Ã—</output></label><input id="sScaleX" type="range" min="0.60" max="2.00" step="0.01" value="1.00"></div>
        <div class="ctrl"><label>Height <output id="oScaleY">1.00Ã—</output></label><input id="sScaleY" type="range" min="0.60" max="2.00" step="0.01" value="1.00"></div>
        <div class="ctrl"><label>Shift (â†”) <output id="oShiftT">0.00</output></label><input id="sShiftT" type="range" min="-0.50" max="0.50" step="0.005" value="0.00"></div>
        <div class="ctrl"><label>Offset (â†•) <output id="oOffsetN">0.00</output></label><input id="sOffsetN" type="range" min="-0.50" max="0.50" step="0.005" value="0.00"></div>
        <div class="ctrl"><label>Temple rot <output id="oTempleRot">5.0Â°</output></label><input id="sTempleRot" type="range" min="-15" max="30" step="0.5" value="5"></div>
      </div>
    </section>
  </main>

  <footer style="padding:10px 16px;color:#a8b3cf">
    æç¤ºï¼šWebCam ä»…åœ¨ <b>HTTPS</b> æˆ– <b>http://localhost</b> ä¸‹å¯ç”¨ï¼›Server æ¨¡å¼åªéœ€åç«¯æä¾› <code>/stream.mjpg</code>ã€‚
  </footer>
</div>

<script>
(() => {
  const video = document.getElementById('cam');
  const img   = document.getElementById('mjpeg');
  const canvas= document.getElementById('overlay');
  const ctx   = canvas.getContext('2d');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const snapBtn  = document.getElementById('snap');
  const permBadge= document.getElementById('perm');
  const fpsBadge = document.getElementById('fps');
  const resBadge = document.getElementById('res');
  const envBadge = document.getElementById('env');
  const btnA = document.getElementById('btnFrameA');
  const btnB = document.getElementById('btnFrameB');
  const btnC = document.getElementById('btnFrameC');
  const frameBadge = document.getElementById('frameBadge');
  const srcWebcam  = document.getElementById('srcWebcam');
  const srcServer  = document.getElementById('srcServer');

  // çŠ¶æ€
  let mode = 'webcam'; // 'webcam' | 'server'
  let stream = null, raf = 0, fps=0, frames=0, last=performance.now();

  // UI è¾…åŠ©
  function setFrame(f){
    frameBadge.textContent = 'Frame: '+f;
    [btnA,btnB,btnC].forEach(b=>b.classList.remove('active'));
    ({A:btnA,B:btnB,C:btnC}[f]).classList.add('active');
    // å¯é€‰ï¼šé€šçŸ¥åç«¯ï¼ˆè‹¥å®ç°äº† /api/frameï¼‰
    fetch('/api/frame', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({frame:f})}).catch(()=>{});
  }
  btnA.onclick=()=>setFrame('A'); btnB.onclick=()=>setFrame('B'); btnC.onclick=()=>setFrame('C');

  function setSource(m){
    mode = m;
    srcWebcam.classList.toggle('active', m==='webcam');
    srcServer.classList.toggle('active', m==='server');
    if (m==='webcam'){ img.style.display='none'; video.style.display='block'; }
    else            { video.style.display='none'; img.style.display='block'; }
  }
  srcWebcam.onclick=()=>setSource('webcam');
  srcServer.onclick=()=>setSource('server');

  function setRunning(r){
    startBtn.disabled = r;
    stopBtn.disabled  = !r;
    snapBtn.disabled  = !r;
  }

  function resizeTo(el){
    const w = (el.videoWidth||el.naturalWidth)|0;
    const h = (el.videoHeight||el.naturalHeight)|0;
    if (!w||!h) return;
    if (canvas.width!==w||canvas.height!==h){
      canvas.width=w; canvas.height=h; resBadge.textContent = `${w} Ã— ${h}`;
    }
  }

  function drawOverlay(){
    const el = (mode==='webcam') ? video : img;
    resizeTo(el);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // è¿™é‡Œå…ˆç”»ä¸ªç½‘æ ¼å ä½ï¼›æœªæ¥å¯åœ¨è¿™é‡Œç”»â€œæ£€æµ‹/å¯¹é½æŒ‡ç¤ºâ€
    ctx.save(); ctx.globalAlpha=.5; ctx.strokeStyle='rgba(255,255,255,.35)'; const w=canvas.width,h=canvas.height;
    for(let i=1;i<=2;i++){ ctx.beginPath(); ctx.moveTo((w/3)*i,0); ctx.lineTo((w/3)*i,h); ctx.stroke();
                           ctx.beginPath(); ctx.moveTo(0,(h/3)*i); ctx.lineTo(w,(h/3)*i); ctx.stroke(); }
    ctx.restore();
    // FPS
    frames++; const now=performance.now(); if(now-last>500){ fps=Math.round(frames*1000/(now-last)); fpsBadge.textContent=`FPS: ${fps}`; frames=0; last=now; }
    raf = requestAnimationFrame(drawOverlay);
  }

  async function start(){
    setRunning(true); permBadge.textContent='Running'; permBadge.className='badge ok';
    cancelAnimationFrame(raf); raf = requestAnimationFrame(drawOverlay);
    if(mode==='webcam'){
      // HTTPS æˆ– localhost æ‰èƒ½å¼€æ‘„åƒå¤´
      const insecure = (location.protocol!=='https:' && location.hostname!=='localhost');
      if(insecure){ envBadge.style.display='inline-block'; envBadge.textContent='éœ€è¦ HTTPS æˆ– localhost æ‰èƒ½ä½¿ç”¨æ‘„åƒå¤´'; setRunning(false); return; }
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:'user'},audio:false});
        video.srcObject = stream; await video.play();
      }catch(e){ permBadge.textContent='æ— æ³•æ‰“å¼€æ‘„åƒå¤´ï¼š'+e.name; permBadge.className='badge err'; setRunning(false); }
    }else{
      // æŒ‡å‘åç«¯ MJPEG æµ
      img.src = '/stream.mjpg'; // åŒæºæ—  CORS é—®é¢˜
      // å‡ºé”™è‡ªåŠ¨é‡è¿
      img.onerror = () => setTimeout(()=>{ img.src = '/stream.mjpg?ts='+Date.now(); }, 800);
    }
  }

  function stop(){
    if(raf) cancelAnimationFrame(raf);
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.pause(); video.srcObject=null; img.removeAttribute('src');
    setRunning(false); fpsBadge.textContent='FPS: â€“'; resBadge.textContent='â€“ Ã— â€“'; permBadge.textContent='Stopped'; permBadge.className='badge';
  }

  function snapshot(){
    const off=document.createElement('canvas');
    const el = (mode==='webcam') ? video : img;
    const w=(el.videoWidth||el.naturalWidth)|0, h=(el.videoHeight||el.naturalHeight)|0;
    if(!w||!h){ alert('æœªå°±ç»ª'); return; }
    off.width=w; off.height=h; const o=off.getContext('2d');
    // æŒ‰é•œåƒç”»å…¥
    o.save(); o.translate(w,0); o.scale(-1,1); o.drawImage(el,0,0,w,h); o.restore();
    // å åŠ  overlay
    o.drawImage(canvas,0,0,w,h);
    const a=document.createElement('a'); a.download=`snapshot_${new Date().toISOString().replace(/[:.]/g,'-')}.png`;
    a.href=off.toDataURL('image/png'); a.click();
  }

  startBtn.onclick=start; stopBtn.onclick=stop; snapBtn.onclick=snapshot;
  window.addEventListener('keydown', e => { if(e.key==='s'||e.key==='S') snapshot(); });

  // â€”â€” å‚æ•°æ»‘å—ï¼ˆå…ˆåªå¯¼å‡º/æ‰“å°ï¼›ä½ æŠŠå®ƒ POST ç»™ /api/params å³å¯ï¼‰â€”â€”
  const autoFit=document.getElementById('autoFit'), sScale=document.getElementById('sScale'), sScaleX=document.getElementById('sScaleX'),
        sScaleY=document.getElementById('sScaleY'), sShiftT=document.getElementById('sShiftT'), sOffsetN=document.getElementById('sOffsetN'),
        sTempleRot=document.getElementById('sTempleRot'),
        oScale=document.getElementById('oScale'), oScaleX=document.getElementById('oScaleX'), oScaleY=document.getElementById('oScaleY'),
        oShiftT=document.getElementById('oShiftT'), oOffsetN=document.getElementById('oOffsetN'), oTempleRot=document.getElementById('oTempleRot'),
        btnReset=document.getElementById('btnReset'), btnExport=document.getElementById('btnExport');

  const defaults={autoFit:true,scale:1,scaleX:1,scaleY:1,shiftT:0,offsetN:0,templeRotDeg:5};
  function read(){ return {autoFit:autoFit.checked,scale:+sScale.value,scaleX:+sScaleX.value,scaleY:+sScaleY.value,shiftT:+sShiftT.value,offsetN:+sOffsetN.value,templeRotDeg:+sTempleRot.value}; }
  function write(v){ autoFit.checked=v.autoFit; sScale.value=v.scale; sScaleX.value=v.scaleX; sScaleY.value=v.scaleY; sShiftT.value=v.shiftT; sOffsetN.value=v.offsetN; sTempleRot.value=v.templeRotDeg; out(); }
  function out(){ const v=read(); oScale.textContent=v.scale.toFixed(2)+'Ã—'; oScaleX.textContent=v.scaleX.toFixed(2)+'Ã—'; oScaleY.textContent=v.scaleY.toFixed(2)+'Ã—';
                  oShiftT.textContent=v.shiftT.toFixed(3); oOffsetN.textContent=v.offsetN.toFixed(3); oTempleRot.textContent=v.templeRotDeg.toFixed(1)+'Â°';
                  // å¯é€‰ï¼šå‘é€åˆ°åç«¯
                  fetch('/api/params',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)}).catch(()=>{}); }
  [autoFit,sScale,sScaleX,sScaleY,sShiftT,sOffsetN,sTempleRot].forEach(el=>el.addEventListener('input',out));
  btnReset.onclick=()=>write(defaults);
  btnExport.onclick=()=>alert(JSON.stringify(read(),null,2));
  write(defaults);
})();
</script>
</body>
</html>
