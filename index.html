<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Web AR Try-On</title>
<style>
:root{--bg:#0b0f19;--panel:#0f1424;--text:#e7ecf3;--accent:#7c3aed}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:#0b0f19;color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
header{display:flex;gap:12px;align-items:center;padding:10px 14px;background:#0e1426;border-bottom:1px solid rgba(255,255,255,.08)}
.brand{font-weight:700}.spacer{flex:1}
.seg{display:flex;gap:6px}
button{border:1px solid rgba(255,255,255,.14);background:#111831;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
button.active{background:var(--accent);border-color:transparent}
.thumbs{display:flex;gap:8px;margin-left:4px}
.thumb{width:64px;height:36px;object-fit:contain;background:#111831;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:2px;cursor:pointer;opacity:.85;transition:.15s}
.thumb:hover{opacity:1}
.thumb.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(124,58,237,.35) inset;opacity:1}
.currThumb{width:80px;height:44px;object-fit:contain;background:#111831;border-radius:8px;border:1px solid rgba(255,255,255,.12);padding:2px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#1f2937;color:#cbd5e1}
.badge.ok{background:#064e3b;color:#d1fae5}
main{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:12px}
.stage{display:grid;place-items:center;min-height:70vh;background:#0e1426;border-radius:12px}
.panel{background:#0e1426;border-radius:12px;padding:12px;display:grid;gap:12px;height:max-content}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.slider{display:grid;grid-template-columns:120px 1fr 64px;gap:8px;align-items:center}
.group{border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:#0f1424}
.group h4{margin:0 0 6px 0;font-size:13px;color:#cbd5e1}
.hint{color:#94a3b8;font-size:12px}
img{max-width:100%;height:auto}
</style>
</head>
<body>
<header>
  <div class="brand">Web AR Try-On</div>

  <div class="seg">
    <button id="btnFrameA" class="active">Frame A</button>
    <button id="btnFrameB">Frame B</button>
    <button id="btnFrameC">Frame C</button>
  </div>

  <div class="thumbs" id="thumbBar">
    <img src="Frame_A.png" id="thumbA" class="thumb active" data-fid="A" alt="Frame A">
    <img src="Frame_B.png" id="thumbB" class="thumb" data-fid="B" alt="Frame B">
    <img src="Frame_C.png" id="thumbC" class="thumb" data-fid="C" alt="Frame C">
  </div>

  <!-- æ–°å¢ï¼šS/M/L æ‰‹åŠ¨é€‰æ‹© & ä¸€æ¬¡æ€§ Auto-Fit -->
  <div class="seg" style="margin-left:8px">
    <button id="btnSizeS">S</button>
    <button id="btnSizeM" class="active">M</button>
    <button id="btnSizeL">L</button>
    <button id="btnFitOnce">Auto fit once</button>
  </div>

  <div class="spacer"></div>

  <img id="currThumb" class="currThumb" src="Frame_A.png" alt="Current frame">
  <span id="frameBadge" class="badge">Frame: A</span>
  <span id="sizeBadge"  class="badge">Size: â€“</span>
  <span id="fpsBadge"   class="badge">FPS: â€“</span>
  <span id="resBadge"   class="badge">â€“ Ã— â€“</span>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <button id="snap">ğŸ“¸ Snapshot</button>
</header>

<main>
  <div class="stage"><img id="mjpeg" alt="MJPEG stream"/></div>

  <div class="panel">
    <div class="row"><span class="badge">Pivot: Eye outer (263/33)</span></div>
    <div class="row">
      <label><input type="checkbox" id="autoHide"> Auto-hide temples</label>
    </div>

    <div class="group">
      <h4>Right temple overrideï¼ˆå±å¹•å³ â†’ åç«¯ Lï¼‰</h4>
      <div class="slider"><label>Right scale</label><input id="sTempleScaleL" type="range" min="0.5" max="1.8" step="0.01" value="1"><output id="oTempleScaleL">1.00Ã—</output></div>
      <div class="slider"><label>Right shift (â†”)</label><input id="sTempleShiftTL" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleShiftTL">0.000</output></div>
      <div class="slider"><label>Right offset (â†•)</label><input id="sTempleOffsetNL" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleOffsetNL">0.000</output></div>
      <div class="slider"><label>Right rot</label><input id="sTempleRotL" type="range" min="-25" max="25" step="0.5" value="5"><output id="oTempleRotL">5.0Â°</output></div>
    </div>

    <div class="group">
      <h4>Left temple overrideï¼ˆå±å¹•å·¦ â†’ åç«¯ Rï¼‰</h4>
      <div class="slider"><label>Left scale</label><input id="sTempleScaleR" type="range" min="0.5" max="1.8" step="0.01" value="1"><output id="oTempleScaleR">1.00Ã—</output></div>
      <div class="slider"><label>Left shift (â†”)</label><input id="sTempleShiftTR" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleShiftTR">0.000</output></div>
      <div class="slider"><label>Left offset (â†•)</label><input id="sTempleOffsetNR" type="range" min="-0.6" max="0.6" step="0.005" value="0"><output id="oTempleOffsetNR">0.000</output></div>
      <div class="slider"><label>Left rot</label><input id="sTempleRotR" type="range" min="-25" max="25" step="0.5" value="-5"><output id="oTempleRotR">-5.0Â°</output></div>
    </div>
  </div>
</main>

<script>
(() => {
  const img = document.getElementById('mjpeg');

  // Frame é€‰æ‹©
  const btnA = document.getElementById('btnFrameA');
  const btnB = document.getElementById('btnFrameB');
  const btnC = document.getElementById('btnFrameC');

  // Size é€‰æ‹©
  const btnSizeS = document.getElementById('btnSizeS');
  const btnSizeM = document.getElementById('btnSizeM');
  const btnSizeL = document.getElementById('btnSizeL');
  const btnFitOnce= document.getElementById('btnFitOnce');

  const frameBadge = document.getElementById('frameBadge');
  const sizeBadge  = document.getElementById('sizeBadge');
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const snapBtn  = document.getElementById('snap');
  const fpsBadge = document.getElementById('fpsBadge');
  const resBadge = document.getElementById('resBadge');
  const currThumb= document.getElementById('currThumb');
  const thumbBar = document.getElementById('thumbBar');
  const autoHide  = document.getElementById('autoHide');

  // é•œè‡‚æ»‘æ†
  const sTempleScaleL=s('sTempleScaleL'), sTempleShiftTL=s('sTempleShiftTL'),
        sTempleOffsetNL=s('sTempleOffsetNL'), sTempleRotL=s('sTempleRotL');
  const sTempleScaleR=s('sTempleScaleR'), sTempleShiftTR=s('sTempleShiftTR'),
        sTempleOffsetNR=s('sTempleOffsetNR'), sTempleRotR=s('sTempleRotR');

  function s(id){ return document.getElementById(id); }
  function o(id){ return document.getElementById(id); }

  function setRunning(r){
    startBtn.disabled = r; stopBtn.disabled = !r; snapBtn.disabled = !r;
  }

  function api(p){ return p; }

  function highlightFrame(fid){
    [btnA,btnB,btnC].forEach(b=>b.classList.remove('active'));
    ({A:btnA,B:btnB,C:btnC}[fid]).classList.add('active');
    [...thumbBar.querySelectorAll('.thumb')].forEach(t=>t.classList.remove('active'));
    ({A:thumbA,B:thumbB,C:thumbC}[fid]).classList.add('active');
    currThumb.src = `Frame_${fid}.png`;
    frameBadge.textContent = 'Frame: ' + fid;
  }

  function setFrame(fid){
    highlightFrame(fid);
    fetch(api('/api/switch_frame'), {method:'POST', headers:{'Content-Type':'application/json'},
           body:JSON.stringify({id:fid})}).catch(()=>{});
  }

  function highlightSize(sz){
    [btnSizeS, btnSizeM, btnSizeL].forEach(b=>b.classList.remove('active'));
    ({S:btnSizeS, M:btnSizeM, L:btnSizeL}[sz] || btnSizeM).classList.add('active');
  }

  function setSize(sz){
    highlightSize(sz);
    fetch(api('/api/size'), {method:'POST', headers:{'Content-Type':'application/json'},
           body:JSON.stringify({size:sz})}).then(()=>pollState()).catch(()=>{});
  }

  function fitOnce(){
    fetch(api('/api/fit_once'), {method:'POST'}).then(()=>pollState()).catch(()=>{});
  }

  function readLeft(){
    return {
      templeScaleL:+sTempleScaleL.value,
      templeShiftTL:+sTempleShiftTL.value,
      templeOffsetNL:+sTempleOffsetNL.value,
      templeRotL:+sTempleRotL.value
    };
  }
  function readRight(){
    return {
      templeScaleR:+sTempleScaleR.value,
      templeShiftTR:+sTempleShiftTR.value,
      templeOffsetNR:+sTempleOffsetNR.value,
      templeRotR:+sTempleRotR.value
    };
  }
  function updateOutputs(){
    o('oTempleScaleL').textContent = (+sTempleScaleL.value).toFixed(2)+'Ã—';
    o('oTempleShiftTL').textContent= (+sTempleShiftTL.value).toFixed(3);
    o('oTempleOffsetNL').textContent=(+sTempleOffsetNL.value).toFixed(3);
    o('oTempleRotL').textContent   = (+sTempleRotL.value).toFixed(1)+'Â°';

    o('oTempleScaleR').textContent = (+sTempleScaleR.value).toFixed(2)+'Ã—';
    o('oTempleShiftTR').textContent= (+sTempleShiftTR.value).toFixed(3);
    o('oTempleOffsetNR').textContent=(+sTempleOffsetNR.value).toFixed(3);
    o('oTempleRotR').textContent   = (+sTempleRotR.value).toFixed(1)+'Â°';
  }
  function postParams(extra){
    const body = Object.assign({}, {autoHideTemples: autoHide.checked}, readLeft(), readRight(), extra||{});
    fetch(api('/api/params'), {method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)}).catch(()=>{});
  }
  function pushAll(){ updateOutputs(); postParams(); }

  // äº‹ä»¶ç»‘å®š
  [autoHide,
   sTempleScaleL,sTempleShiftTL,sTempleOffsetNL,sTempleRotL,
   sTempleScaleR,sTempleShiftTR,sTempleOffsetNR,sTempleRotR
  ].forEach(el => el.addEventListener('input', ()=>{ updateOutputs(); postParams(); }));

  btnA.onclick = ()=>setFrame('A');
  btnB.onclick = ()=>setFrame('B');
  btnC.onclick = ()=>setFrame('C');
  thumbBar.addEventListener('click', (e)=>{
    const t = e.target.closest('.thumb'); if(!t) return;
    setFrame(t.dataset.fid);
  });

  btnSizeS.onclick = ()=>setSize('S');
  btnSizeM.onclick = ()=>setSize('M');
  btnSizeL.onclick = ()=>setSize('L');
  btnFitOnce.onclick = ()=>fitOnce();

  // å¯åœä¸å¿«ç…§
  let raf=0, frames=0, last=performance.now();
  function loop(){
    frames++; const now=performance.now();
    if(now-last>500){ const fps=Math.round(frames*1000/(now-last)); fpsBadge.textContent=`FPS: ${fps}`; frames=0; last=now; }
    const w=img.naturalWidth|0, h=img.naturalHeight|0; if(w&&h) resBadge.textContent=`${w} Ã— ${h}`;
    raf = requestAnimationFrame(loop);
  }
  document.getElementById('start').onclick = () => {
    setRunning(true);
    cancelAnimationFrame(raf); raf=requestAnimationFrame(loop);
    img.onerror = () => setTimeout(()=>{ img.src = '/stream.mjpg?ts='+Date.now(); }, 800);
    img.src = '/stream.mjpg?ts='+Date.now();
    pushAll();
  };
  document.getElementById('stop').onclick = () => {
    if(raf) cancelAnimationFrame(raf);
    img.removeAttribute('src');
    setRunning(false);
  };
  document.getElementById('snap').onclick = () => {
    const a=document.createElement('a'); a.download=`snapshot_${Date.now()}.jpg`; a.href='/snapshot'; a.click();
  };

  // è½®è¯¢æ˜¾ç¤ºå½“å‰ Frame/Size ä¸æ¨¡å¼
  function pollState(){
    fetch('/api/params').then(r=>r.json()).then(st=>{
      const fid = (st && st.frameId) || 'A';
      highlightFrame(fid);
      const sz  = (st && st.size) || 'M';
      highlightSize(sz);
      const mode = (st && st.fitMode) || 'once';
      sizeBadge.textContent = `Size: ${sz} (${mode})`;
    }).catch(()=>{ /* ignore */ });
  }
  setInterval(pollState, 1000);
  pollState(); // åˆæ¬¡
})();
</script>
</body>
</html>
